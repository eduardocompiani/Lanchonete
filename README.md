# CODIGO MYSQL PARA CRIACAO DO BANCO

```
CREATE DATABASE LANCHONETEDB;
USE LANCHONETEDB;
CREATE TABLE PRODUTO(
	CDPRODUTO INT PRIMARY KEY AUTO_INCREMENT,
    NMPRODUTO VARCHAR(255) NOT NULL,
    VLPRODUTO FLOAT NOT NULL
);
CREATE TABLE COMBO(
	CDCOMBO INT PRIMARY KEY AUTO_INCREMENT,
    NMCOMBO VARCHAR(255) NOT NULL,
    VLDESCONTO FLOAT NOT NULL,
    VLCOMBO FLOAT
);
CREATE TABLE PRODUTO_DO_COMBO(
	CDCOMBO INT,
    CDPRODUTO INT,
    CONSTRAINT FK_COMBO FOREIGN KEY (CDCOMBO) REFERENCES COMBO(CDCOMBO),
    CONSTRAINT FK_PRODUTO FOREIGN KEY (CDPRODUTO) REFERENCES PRODUTO(CDPRODUTO)
);
CREATE TABLE PEDIDO(
	CDPEDIDO INT PRIMARY KEY AUTO_INCREMENT,
    VLTOTAL FLOAT
);
CREATE TABLE PEDIDO_ITEM(
    CDPEDIDO INT,
    CDCOMBO INT NULL,
    CDPRODUTO INT NULL,
    QTDPEDIDO INT NOT NULL,
    CONSTRAINT FK_PEDIDO_ITEM FOREIGN KEY (CDPEDIDO) REFERENCES PEDIDO(CDPEDIDO),
    CONSTRAINT FK_PRODUTO_ITEM FOREIGN KEY (CDPRODUTO) REFERENCES PRODUTO(CDPRODUTO),
    CONSTRAINT FK_COMBO_ITEM FOREIGN KEY (CDCOMBO) REFERENCES COMBO(CDCOMBO)
);
CREATE VIEW PRODUTO_VENDA AS 
    SELECT
        1 AS IS_PRODUTO,
        PRODUTO.CDPRODUTO AS CDPRODUTO_VENDA,
        PRODUTO.NMPRODUTO AS NMPRODUTO_VENDA,
        PRODUTO.VLPRODUTO AS VLPRODUTO_VENDA
    FROM
        PRODUTO
    UNION
    SELECT

        0 AS IS_PRODUTO,
        COMBO.CDCOMBO AS CDPRODUTO_VENDA,
        COMBO.NMCOMBO AS NMPRODUTO_VENDA,
        SUM(PRODUTO.VLPRODUTO - (PRODUTO.VLPRODUTO * (COMBO.VLDESCONTO/100)) ) AS VLPRODUTO_VENDA
    FROM
        COMBO
        INNER JOIN PRODUTO_DO_COMBO ON (COMBO.CDCOMBO = PRODUTO_DO_COMBO.CDCOMBO)
        INNER JOIN PRODUTO ON (PRODUTO.CDPRODUTO = PRODUTO_DO_COMBO.CDPRODUTO)
    GROUP BY
        IS_PRODUTO,
        CDPRODUTO_VENDA,
        NMPRODUTO_VENDA;


DELIMITER $$
CREATE PROCEDURE PEGA_NOVO_VALOR_DO_COMBO(IN CODIGO INT, OUT VALOR FLOAT)
BEGIN
    SET VALOR := (SELECT 
        SUM(PRODUTO.VLPRODUTO - (PRODUTO.VLPRODUTO * (COMBO.VLDESCONTO/100))) AS VALOR
    FROM 
        PRODUTO 
        INNER JOIN PRODUTO_DO_COMBO ON (PRODUTO_DO_COMBO.CDPRODUTO = PRODUTO.CDPRODUTO)
        INNER JOIN COMBO ON (COMBO.CDCOMBO = PRODUTO_DO_COMBO.CDCOMBO)
    WHERE 
        PRODUTO_DO_COMBO.CDCOMBO = CODIGO);
END $$
DELIMITER ;


DELIMITER $$
CREATE PROCEDURE PEGA_NOVO_VALOR_DO_PEDIDO(IN CODIGO INT, OUT VALOR FLOAT)
BEGIN
    SET VALOR := (SELECT
            SUM(CASE
                WHEN PEDIDO_ITEM.CDCOMBO IS NULL THEN PRODUTO.VLPRODUTO
                ELSE COMBO.VLCOMBO
            END)
        FROM
            PEDIDO_ITEM
            LEFT OUTER JOIN PRODUTO ON (PRODUTO.CDPRODUTO = PEDIDO_ITEM.CDPRODUTO)
            LEFT OUTER JOIN COMBO ON (COMBO.CDCOMBO = PEDIDO_ITEM.CDCOMBO)
        WHERE
            PEDIDO_ITEM.CDPEDIDO =  CODIGO);
END $$
DELIMITER ;


DELIMITER $$
CREATE PROCEDURE CRIA_PRODUTO(IN NOME VARCHAR(255), IN VALOR FLOAT)
BEGIN
    INSERT INTO PRODUTO (NMPRODUTO, VLPRODUTO) VALUES (NOME, VALOR);
END $$
DELIMITER ;


DELIMITER $$
CREATE PROCEDURE CRIA_COMBO(IN NOME VARCHAR(255), IN DESCONTO FLOAT, IN CODIGO INT)
BEGIN
    INSERT INTO COMBO(NMCOMBO, VLDESCONTO, VLCOMBO) VALUES (NOME, DESCONTO, (SELECT VLPRODUTO * (DESCONTO/100) FROM PRODUTO WHERE CDPRODUTO = CODIGO));
    INSERT INTO PRODUTO_DO_COMBO(CDCOMBO, CDPRODUTO) VALUES (LAST_INSERT_ID(), CODIGO);
END $$
DELIMITER ;


DELIMITER $$
CREATE PROCEDURE ADICIONA_ITEM_COMBO(IN CODCOMBO INT, IN CODIGO INT)
BEGIN
    INSERT INTO PRODUTO_DO_COMBO(CDCOMBO, CDPRODUTO) VALUES (CODCOMBO, CODIGO);
    UPDATE COMBO SET VLCOMBO = (VLCOMBO + (SELECT VLPRODUTO FROM PRODUTO WHERE CDPRODUTO = CODIGO)) WHERE CDCOMBO = CODCOMBO;
END $$
DELIMITER ;


DELIMITER $$
CREATE PROCEDURE CRIA_PEDIDO(IN CODIGO INT, IN QUANTIDADE INT, IN E_PRODUTO BOOLEAN)
BEGIN
    IF(E_PRODUTO) THEN
        SET @VALOR = (SELECT VLPRODUTO * QUANTIDADE FROM PRODUTO WHERE CDPRODUTO = CODIGO);
    ELSE
        SET @VALOR = (SELECT VLCOMBO * QUANTIDADE FROM COMBO WHERE CDCOMBO = CODIGO);
    END IF;
    
    INSERT INTO PEDIDO (VLTOTAL) VALUES (@VALOR);

    IF(E_PRODUTO) THEN
        INSERT INTO PEDIDO_ITEM (CDPEDIDO, CDPRODUTO, QTDPEDIDO) VALUES (LAST_INSERT_ID(), CODIGO, QUANTIDADE);
    ELSE
        INSERT INTO PEDIDO_ITEM (CDPEDIDO, CDCOMBO, QTDPEDIDO) VALUES (LAST_INSERT_ID(), CODIGO, QUANTIDADE);
    END IF;
END $$
DELIMITER ;


DELIMITER $$
CREATE PROCEDURE ADICIONA_ITEM_PEDIDO(IN CODIGO_PEDIDO INT,IN CODIGO_ITEM INT, IN QUANTIDADE INT, IN E_PRODUTO BOOLEAN)
BEGIN
    IF(E_PRODUTO) THEN
        SET @VALOR = (SELECT VLPRODUTO * QUANTIDADE FROM PRODUTO WHERE CDPRODUTO = CODIGO_ITEM);
    ELSE
        SET @VALOR = (SELECT VLCOMBO * QUANTIDADE FROM COMBO WHERE CDCOMBO = CODIGO_ITEM);
    END IF;
    
    UPDATE PEDIDO SET VLTOTAL = (VLTOTAL + @VALOR) WHERE CDPEDIDO = CODIGO_PEDIDO;

    IF(E_PRODUTO) THEN
        INSERT INTO PEDIDO_ITEM (CDPEDIDO, CDPRODUTO, QTDPEDIDO) VALUES (CODIGO_PEDIDO, CODIGO_ITEM, QUANTIDADE);
    ELSE
        INSERT INTO PEDIDO_ITEM (CDPEDIDO, CDCOMBO, QTDPEDIDO) VALUES (CODIGO_PEDIDO, CODIGO_ITEM, QUANTIDADE);
    END IF;
END $$
DELIMITER ;


```